name: Code Quality (Lint)

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]
  workflow_dispatch:

concurrency:
  group: lint-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ktlint:
    name: Kotlin Formatting (ktlint)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run ktlint
        run: ./gradlew ktlintCheck --continue

      - name: Upload ktlint reports
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ktlint-reports
          path: |
            **/build/reports/ktlint/
          retention-days: 7

  detekt:
    name: Static Analysis (detekt)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run detekt
        run: ./gradlew detekt --continue

      - name: Upload detekt reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: detekt-reports
          path: |
            shared/build/reports/detekt/
            composeApp/build/reports/detekt/
          retention-days: 7

      - name: Upload SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: shared/build/reports/detekt/detekt.sarif
        continue-on-error: true

  android-lint:
    name: Android Lint
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Create local.properties
        run: |
          echo "MAPS_API_KEY=dummy_key_for_ci" > local.properties

      - name: Run Android Lint
        run: ./gradlew :composeApp:lint --continue

      - name: Upload Android Lint reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-lint-reports
          path: |
            composeApp/build/reports/lint-results*.html
            composeApp/build/reports/lint-results*.xml
          retention-days: 7

  swiftlint:
    name: Swift Linting (SwiftLint)
    runs-on: macos-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Run SwiftLint
        working-directory: iosApp
        run: swiftlint lint --strict --reporter github-actions-logging

      - name: Run SwiftLint (generate report)
        if: always()
        working-directory: iosApp
        run: swiftlint lint --reporter html > swiftlint-report.html
        continue-on-error: true

      - name: Upload SwiftLint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: swiftlint-report
          path: iosApp/swiftlint-report.html
          retention-days: 7

  lint-summary:
    name: Lint Summary
    runs-on: ubuntu-latest
    needs: [ktlint, detekt, android-lint, swiftlint]
    if: always()

    steps:
      - name: Check lint results
        run: |
          echo "Lint Results:"
          echo "- ktlint: ${{ needs.ktlint.result }}"
          echo "- detekt: ${{ needs.detekt.result }}"
          echo "- android-lint: ${{ needs.android-lint.result }}"
          echo "- swiftlint: ${{ needs.swiftlint.result }}"

      - name: Fail if any linter failed
        if: |
          needs.ktlint.result == 'failure' ||
          needs.detekt.result == 'failure' ||
          needs.android-lint.result == 'failure' ||
          needs.swiftlint.result == 'failure'
        run: exit 1
